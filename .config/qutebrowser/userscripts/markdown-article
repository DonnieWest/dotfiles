#!/usr/bin/env python3
import os
import sys
import tempfile
import shutil

qute_fifo = os.environ.get('QUTE_FIFO')

def qute_command(command):
    with open(qute_fifo, 'w') as f:
        f.write(command + '\n')
        f.flush()

if not qute_fifo:
    sys.stderr.write("QUTE_FIFO not set\n")
    sys.exit(1)

# JavaScript for detecting and clipping main article content
script = r"""
(function() {
    function findMainArticle() {
        const selectors = [
            'article',
            '[role="main"]',
            'main',
            '.article',
            '.post',
            '.content',
            '.entry-content',
            '#content',
            '#main-content',
            '[class*="article"]',
            '[class*="post"]',
            '[id*="article"]',
            '[id*="post"]',
        ];
        
        for (const selector of selectors) {
            const el = document.querySelector(selector);
            if (el) {
                const score = el.textContent.length * (el.querySelector('p') ? 2 : 1);
                return { el, score, selector };
            }
        }
        
        const allDivs = document.querySelectorAll('div, section, article');
        let best = null;
        let maxP = 0;
        
        allDivs.forEach(div => {
            const pCount = div.querySelectorAll('p').length;
            if (pCount > maxP && pCount >= 3) {
                const textLen = div.textContent.length;
                if (textLen > 200 && textLen < 50000) {
                    maxP = pCount;
                    best = div;
                }
            }
        });
        
        return { el: best, score: maxP };
    }

    function htmlToMarkdown(el) {
        const clone = el.cloneNode(true);
        const unwanted = clone.querySelectorAll('script, style, iframe, noscript, nav, footer, header, aside, .ads, .advertisement, [class*="ad-"]');
        unwanted.forEach(n => n.remove());
        
        let html = clone.innerHTML;
        
        html = html.replace(/<h([1-6])[^>]*>(.*?)<\/h\1>/gi, (m, n, c) => '#'.repeat(+n) + ' ' + c.trim() + '\n\n');
        html = html.replace(/<strong[^>]*>(.*?)<\/strong>/gi, '**$1**');
        html = html.replace(/<b[^>]*>(.*?)<\/b>/gi, '**$1**');
        html = html.replace(/<em[^>]*>(.*?)<\/em>/gi, '*$1*');
        html = html.replace(/<i[^>]*>(.*?)<\/i>/gi, '*$1*');
        html = html.replace(/<code[^>]*>(.*?)<\/code>/gi, '`$1`');
        html = html.replace(/<pre[^>]*>((?:.|\n)*?)<\/pre>/gi, '```\n$1\n```\n\n');
        html = html.replace(/<a[^>]+href=["'"]([^"']*)["'"][^>]*>(.*?)<\/a>/gi, '[$2]($1)');
        html = html.replace(/<img[^>]+src=["'"]([^"']*)["'"][^>]+alt=["'"]([^"']*)["'"][^>]*>/gi, '![$2]($1)');
        html = html.replace(/<img[^>]+src=["'"]([^"']*)["'"][^>]*>/gi, '![]($1)');
        html = html.replace(/<p[^>]*>(.*?)<\/p>/gi, '$1\n\n');
        html = html.replace(/<div[^>]*>(.*?)<\/div>/gi, '$1');
        html = html.replace(/<br\s*\/?>/gi, '\n');
        html = html.replace(/<li[^>]*>(.*?)<\/li>/gi, '- $1\n');
        html = html.replace(/<ul[^>]*>/gi, '');
        html = html.replace(/<\/ul>/gi, '\n');
        html = html.replace(/<ol[^>]*>/gi, '');
        html = html.replace(/<\/ol>/gi, '\n');
        html = html.replace(/<[^>]+>/g, '');
        
        html = html.replace(/&nbsp;/g, ' ');
        html = html.replace(/&amp;/g, '&');
        html = html.replace(/&lt;/g, '<');
        html = html.replace(/&gt;/g, '>');
        html = html.replace(/&quot;/g, '"');
        html = html.replace(/&#39;/g, "'");
        
        html = html.replace(/\n{3,}/g, '\n\n');
        
        return html.trim();
    }

    const result = findMainArticle();
    
    if (!result.el) {
        console.error('Could not find main article content');
        const errEl = document.createElement('div');
        errEl.style.cssText = 'position:fixed;top:10px;left:50%;transform:translateX(-50%);background:red;color:white;padding:8px 16px;border-radius:4px;z-index:2147483647;';
        errEl.textContent = 'No article content found';
        document.body.appendChild(errEl);
        setTimeout(() => errEl.remove(), 2000);
        return;
    }

    const md = htmlToMarkdown(result.el);
    const url = window.location.href;
    const title = document.title;
    const date = new Date().toISOString().slice(0, 10);
    
    const finalMd = `# ${title}\n\nSource: ${url}\nClipped: ${date}\n\n---\n\n${md}`;

    function copyToClipboard(text) {
        if (navigator.clipboard) {
            return navigator.clipboard.writeText(text);
        }
        const el = document.createElement('textarea');
        el.value = text;
        el.style.position = 'fixed';
        el.style.left = '-9999px';
        document.body.appendChild(el);
        el.select();
        document.execCommand('copy');
        el.remove();
        return Promise.resolve();
    }

    copyToClipboard(finalMd).then(() => {
        const msg = document.createElement('div');
        msg.style.cssText = 'position:fixed;top:10px;left:50%;transform:translateX(-50%);background:green;color:white;padding:8px 16px;border-radius:4px;z-index:2147483647;font-family:sans-serif;';
        msg.textContent = 'Article copied as Markdown âœ“';
        document.body.appendChild(msg);
        setTimeout(() => msg.remove(), 2000);
    }).catch(err => {
        console.error('Copy failed:', err);
        const errEl = document.createElement('div');
        errEl.style.cssText = 'position:fixed;top:10px;left:50%;transform:translateX(-50%);background:red;color:white;padding:8px 16px;border-radius:4px;z-index:2147483647;';
        errEl.textContent = 'Copy failed';
        document.body.appendChild(errEl);
        setTimeout(() => errEl.remove(), 2000);
    });
})()
"""

# Write JS to a temporary file
temp_dir = tempfile.mkdtemp()
js_file = os.path.join(temp_dir, 'article_clipper.js')
with open(js_file, 'w') as f:
    f.write(script)

qute_command(f'jseval -f {js_file}')
qute_command('message-info "Clipping article as Markdown..."')

# Clean up temp dir after a delay
import atexit
def cleanup():
    import time
    time.sleep(2)
    try:
        shutil.rmtree(temp_dir)
    except:
        pass
atexit.register(cleanup)